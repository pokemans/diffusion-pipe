<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Training Job Manager</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <header>
            <h1>Training Job Manager</h1>
            <div class="job-selector">
                <label for="jobSelect">Job:</label>
                <select id="jobSelect">
                    <option value="">Select a job...</option>
                </select>
                <button id="createJobBtn">Create New Job</button>
            </div>
        </header>

        <div id="jobsOverview">
            <h2>Jobs Overview</h2>
            <table class="overview-table">
                <thead>
                    <tr>
                        <th>Job Name</th>
                        <th>Status</th>
                        <th>Last Step</th>
                        <th>Last Loss</th>
                    </tr>
                </thead>
                <tbody id="overviewTableBody">
                    <tr>
                        <td colspan="4" class="empty-state">Loading jobs...</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div id="jobContent" class="hidden">
            <div class="tabs">
                <button class="tab-btn active" data-tab="config">Job Config</button>
                <button class="tab-btn" data-tab="dataset">Dataset Config</button>
                <button class="tab-btn" data-tab="monitor">Monitor</button>
            </div>

            <div class="tab-content active" id="configTab">
                <div class="editor-container">
                    <div class="editor-header">
                        <h3>Job Config (job_config.toml)</h3>
                        <button id="saveJobConfigBtn" class="save-btn">Save</button>
                    </div>
                    <textarea id="jobConfigEditor" class="editor"></textarea>
                </div>
            </div>

            <div class="tab-content" id="datasetTab">
                <div class="editor-container">
                    <div class="editor-header">
                        <h3>Dataset Config (dataset.toml)</h3>
                        <button id="saveDatasetConfigBtn" class="save-btn">Save</button>
                    </div>
                    <textarea id="datasetConfigEditor" class="editor"></textarea>
                </div>
            </div>

            <div class="tab-content" id="monitorTab">
                <div class="controls">
                    <button id="launchBtn" class="launch-btn">Launch Job</button>
                    <button id="stopBtn" class="stop-btn hidden">Stop Job</button>
                    <span id="jobStatus" class="status"></span>
                </div>

                <div class="monitor-grid">
                    <div class="log-container">
                        <div class="log-header">
                            <h3>Logs</h3>
                            <button id="clearLogsBtn" class="clear-btn">Clear</button>
                        </div>
                        <div id="logDisplay" class="log-display"></div>
                    </div>

                    <div class="plot-container">
                        <div class="plot-header">
                            <h3>Loss vs Steps</h3>
                        </div>
                        <div class="plot-controls">
                            <div class="control-group">
                                <label>
                                    <input type="checkbox" id="movingAvgToggle">
                                    Moving Average
                                </label>
                                <div id="windowSizeGroup" class="window-size-group hidden">
                                    <label for="windowSizeSlider">Window Size:</label>
                                    <input type="range" id="windowSizeSlider" min="1" max="50" value="10">
                                    <span id="windowSizeValue">10</span>
                                </div>
                            </div>
                            <div class="control-group">
                                <label for="minStepInput">Min Step:</label>
                                <input type="number" id="minStepInput" min="0" placeholder="Auto">
                                <label for="maxStepInput">Max Step:</label>
                                <input type="number" id="maxStepInput" min="0" placeholder="Auto">
                                <button id="applyRangeBtn" class="small-btn">Apply Range</button>
                            </div>
                            <div class="control-group">
                                <button id="resetZoomBtn" class="small-btn">Reset Zoom</button>
                                <label id="showRawLabel" class="hidden">
                                    <input type="checkbox" id="showRawToggle">
                                    Show Raw
                                </label>
                            </div>
                        </div>
                        <div id="lossPlot" class="plot"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let socket = null;
        let currentJob = null;
        let lossData = {
            rawSteps: [],
            rawLosses: [],
            steps: [],
            losses: []
        };
        let plotSettings = {
            movingAverage: false,
            windowSize: 10,
            minStep: null,
            maxStep: null,
            showRaw: false
        };
        let overviewRefreshInterval = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadJobs();
            loadJobsOverview();
            setupEventListeners();
            startOverviewRefresh();
        });

        function setupEventListeners() {
            // Job selector
            document.getElementById('jobSelect').addEventListener('change', (e) => {
                const jobName = e.target.value;
                if (jobName) {
                    loadJob(jobName);
                    hideOverview();
                } else {
                    hideJobContent();
                    showOverview();
                }
            });

            // Create job button
            document.getElementById('createJobBtn').addEventListener('click', () => {
                const jobName = prompt('Enter job name:');
                if (jobName && jobName.trim()) {
                    createJob(jobName.trim());
                }
            });

            // Tab switching
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const tab = btn.dataset.tab;
                    switchTab(tab);
                });
            });

            // Save buttons
            document.getElementById('saveJobConfigBtn').addEventListener('click', () => {
                saveJobConfig();
            });

            document.getElementById('saveDatasetConfigBtn').addEventListener('click', () => {
                saveDatasetConfig();
            });

            // Launch/Stop buttons
            document.getElementById('launchBtn').addEventListener('click', () => {
                launchJob();
            });

            document.getElementById('stopBtn').addEventListener('click', () => {
                stopJob();
            });

            // Clear logs
            document.getElementById('clearLogsBtn').addEventListener('click', () => {
                document.getElementById('logDisplay').innerHTML = '';
            });

            // Plot controls
            document.getElementById('movingAvgToggle').addEventListener('change', (e) => {
                plotSettings.movingAverage = e.target.checked;
                const windowSizeGroup = document.getElementById('windowSizeGroup');
                const showRawLabel = document.getElementById('showRawLabel');
                if (plotSettings.movingAverage) {
                    windowSizeGroup.classList.remove('hidden');
                    showRawLabel.classList.remove('hidden');
                } else {
                    windowSizeGroup.classList.add('hidden');
                    showRawLabel.classList.add('hidden');
                    plotSettings.showRaw = false;
                    document.getElementById('showRawToggle').checked = false;
                }
                applyPlotSettings();
                updatePlot();
            });

            document.getElementById('windowSizeSlider').addEventListener('input', (e) => {
                plotSettings.windowSize = parseInt(e.target.value);
                document.getElementById('windowSizeValue').textContent = plotSettings.windowSize;
                if (plotSettings.movingAverage) {
                    applyPlotSettings();
                    updatePlot();
                }
            });

            document.getElementById('applyRangeBtn').addEventListener('click', () => {
                const minStepInput = document.getElementById('minStepInput');
                const maxStepInput = document.getElementById('maxStepInput');
                const minStep = minStepInput.value.trim() === '' ? null : parseInt(minStepInput.value);
                const maxStep = maxStepInput.value.trim() === '' ? null : parseInt(maxStepInput.value);
                
                if (minStep !== null && maxStep !== null && minStep >= maxStep) {
                    alert('Min step must be less than max step');
                    return;
                }
                
                plotSettings.minStep = minStep;
                plotSettings.maxStep = maxStep;
                applyPlotSettings();
                updatePlot();
            });

            document.getElementById('resetZoomBtn').addEventListener('click', () => {
                Plotly.relayout('lossPlot', {
                    'xaxis.autorange': true,
                    'yaxis.autorange': true
                });
            });

            document.getElementById('showRawToggle').addEventListener('change', (e) => {
                plotSettings.showRaw = e.target.checked;
                updatePlot();
            });
        }

        async function loadJobs() {
            try {
                const response = await fetch('/api/jobs');
                const data = await response.json();
                const select = document.getElementById('jobSelect');
                select.innerHTML = '<option value="">Select a job...</option>';
                data.jobs.forEach(job => {
                    const option = document.createElement('option');
                    option.value = job;
                    option.textContent = job;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading jobs:', error);
            }
        }

        async function loadJobsOverview() {
            try {
                const response = await fetch('/api/jobs/overview');
                const data = await response.json();
                const tbody = document.getElementById('overviewTableBody');
                
                if (!data.jobs || data.jobs.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" class="empty-state">No jobs found</td></tr>';
                    return;
                }
                
                tbody.innerHTML = data.jobs.map(job => {
                    const statusClass = `status-badge ${job.status}`;
                    const statusText = job.status.charAt(0).toUpperCase() + job.status.slice(1);
                    const lastStep = job.last_step !== null ? job.last_step : '-';
                    const lastLoss = job.last_loss !== null ? job.last_loss.toFixed(4) : '-';
                    
                    return `
                        <tr class="job-row" data-job="${job.job_name}">
                            <td class="job-name-cell">${job.job_name}</td>
                            <td><span class="${statusClass}">${statusText}</span></td>
                            <td>${lastStep}</td>
                            <td>${lastLoss}</td>
                        </tr>
                    `;
                }).join('');
                
                // Add click handlers to job name cells
                tbody.querySelectorAll('.job-name-cell').forEach(cell => {
                    cell.style.cursor = 'pointer';
                    cell.addEventListener('click', (e) => {
                        const jobName = e.target.closest('.job-row').dataset.job;
                        document.getElementById('jobSelect').value = jobName;
                        document.getElementById('jobSelect').dispatchEvent(new Event('change'));
                    });
                });
            } catch (error) {
                console.error('Error loading jobs overview:', error);
                const tbody = document.getElementById('overviewTableBody');
                tbody.innerHTML = '<tr><td colspan="4" class="empty-state">Error loading overview</td></tr>';
            }
        }

        function showOverview() {
            document.getElementById('jobsOverview').classList.remove('hidden');
            startOverviewRefresh();
        }

        function hideOverview() {
            document.getElementById('jobsOverview').classList.add('hidden');
            stopOverviewRefresh();
        }

        function startOverviewRefresh() {
            stopOverviewRefresh();
            overviewRefreshInterval = setInterval(() => {
                if (!currentJob) {
                    loadJobsOverview();
                }
            }, 3000);
        }

        function stopOverviewRefresh() {
            if (overviewRefreshInterval) {
                clearInterval(overviewRefreshInterval);
                overviewRefreshInterval = null;
            }
        }

        async function createJob(jobName) {
            try {
                // Create empty config files
                await fetch(`/api/jobs/${jobName}/config`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ content: '# Job configuration\n' })
                });

                await fetch(`/api/jobs/${jobName}/dataset`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ content: '# Dataset configuration\n' })
                });

                await loadJobs();
                await loadJobsOverview();
                document.getElementById('jobSelect').value = jobName;
                loadJob(jobName);
            } catch (error) {
                console.error('Error creating job:', error);
                alert('Error creating job: ' + error.message);
            }
        }

        async function loadJob(jobName) {
            currentJob = jobName;
            hideJobContent();
            hideOverview();

            try {
                // Load configs
                const [configRes, datasetRes] = await Promise.all([
                    fetch(`/api/jobs/${jobName}/config`),
                    fetch(`/api/jobs/${jobName}/dataset`)
                ]);

                if (configRes.ok) {
                    const configData = await configRes.json();
                    document.getElementById('jobConfigEditor').value = configData.content;
                }

                if (datasetRes.ok) {
                    const datasetData = await datasetRes.json();
                    document.getElementById('datasetConfigEditor').value = datasetData.content;
                }

                // Load status
                await updateJobStatus();

                // Connect to WebSocket
                connectWebSocket(jobName);

                // Show content
                document.getElementById('jobContent').classList.remove('hidden');
            } catch (error) {
                console.error('Error loading job:', error);
                alert('Error loading job: ' + error.message);
            }
        }

        function hideJobContent() {
            document.getElementById('jobContent').classList.add('hidden');
            if (socket) {
                socket.disconnect();
                socket = null;
            }
        }

        function switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.tab === tabName);
            });

            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.toggle('active', content.id === `${tabName}Tab`);
            });
        }

        async function saveJobConfig() {
            if (!currentJob) return;

            const content = document.getElementById('jobConfigEditor').value;
            try {
                const response = await fetch(`/api/jobs/${currentJob}/config`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ content })
                });

                if (response.ok) {
                    alert('Job config saved successfully');
                } else {
                    const error = await response.json();
                    alert('Error saving config: ' + error.error);
                }
            } catch (error) {
                alert('Error saving config: ' + error.message);
            }
        }

        async function saveDatasetConfig() {
            if (!currentJob) return;

            const content = document.getElementById('datasetConfigEditor').value;
            try {
                const response = await fetch(`/api/jobs/${currentJob}/dataset`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ content })
                });

                if (response.ok) {
                    alert('Dataset config saved successfully');
                } else {
                    const error = await response.json();
                    alert('Error saving config: ' + error.error);
                }
            } catch (error) {
                alert('Error saving config: ' + error.message);
            }
        }

        async function launchJob() {
            if (!currentJob) return;

            try {
                const response = await fetch(`/api/jobs/${currentJob}/launch`, {
                    method: 'POST'
                });

                if (response.ok) {
                    // Clear previous logs and plot
                    document.getElementById('logDisplay').innerHTML = '';
                    lossData = {
                        rawSteps: [],
                        rawLosses: [],
                        steps: [],
                        losses: []
                    };
                    plotSettings.minStep = null;
                    plotSettings.maxStep = null;
                    document.getElementById('minStepInput').value = '';
                    document.getElementById('maxStepInput').value = '';
                    applyPlotSettings();
                    updatePlot();

                    // Update UI
                    document.getElementById('launchBtn').classList.add('hidden');
                    document.getElementById('stopBtn').classList.remove('hidden');
                    document.getElementById('jobStatus').textContent = 'Status: Running';
                    document.getElementById('jobStatus').className = 'status running';

                    // Switch to monitor tab
                    switchTab('monitor');
                } else {
                    const error = await response.json();
                    alert('Error launching job: ' + error.error);
                }
            } catch (error) {
                alert('Error launching job: ' + error.message);
            }
        }

        async function stopJob() {
            if (!currentJob) return;

            try {
                const response = await fetch(`/api/jobs/${currentJob}/stop`, {
                    method: 'POST'
                });

                if (response.ok) {
                    document.getElementById('launchBtn').classList.remove('hidden');
                    document.getElementById('stopBtn').classList.add('hidden');
                    document.getElementById('jobStatus').textContent = 'Status: Stopped';
                    document.getElementById('jobStatus').className = 'status stopped';
                } else {
                    const error = await response.json();
                    alert('Error stopping job: ' + error.error);
                }
            } catch (error) {
                alert('Error stopping job: ' + error.message);
            }
        }

        async function updateJobStatus() {
            if (!currentJob) return;

            // #region agent log
            fetch('http://127.0.0.1:7242/ingest/e751b283-9917-439e-b940-0a7eca19244e',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'index.html:533',message:'updateJobStatus entry',data:{currentJob,rawStepsLength:lossData.rawSteps.length,rawLossesLength:lossData.rawLosses.length,stepsLength:lossData.steps.length,lossesLength:lossData.losses.length},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'A'})}).catch(()=>{});
            // #endregion

            try {
                const response = await fetch(`/api/jobs/${currentJob}/status`);
                const status = await response.json();

                // #region agent log
                fetch('http://127.0.0.1:7242/ingest/e751b283-9917-439e-b940-0a7eca19244e',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'index.html:540',message:'status response received',data:{running:status.running,statisticsLength:status.statistics?.length||0,hasStatistics:!!status.statistics},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'A'})}).catch(()=>{});
                // #endregion

                if (status.running) {
                    document.getElementById('launchBtn').classList.add('hidden');
                    document.getElementById('stopBtn').classList.remove('hidden');
                    document.getElementById('jobStatus').textContent = 'Status: Running';
                    document.getElementById('jobStatus').className = 'status running';
                } else {
                    document.getElementById('launchBtn').classList.remove('hidden');
                    document.getElementById('stopBtn').classList.add('hidden');
                    document.getElementById('jobStatus').textContent = 'Status: Stopped';
                    document.getElementById('jobStatus').className = 'status stopped';
                }

                // Update plot with existing statistics
                if (status.statistics && status.statistics.length > 0) {
                    // #region agent log
                    fetch('http://127.0.0.1:7242/ingest/e751b283-9917-439e-b940-0a7eca19244e',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'index.html:555',message:'before overwriting raw data',data:{oldRawStepsLength:lossData.rawSteps.length,newStatsLength:status.statistics.length,firstStep:status.statistics[0]?.step,lastStep:status.statistics[status.statistics.length-1]?.step},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'A'})}).catch(()=>{});
                    // #endregion
                    lossData.rawSteps = status.statistics.map(s => s.step);
                    lossData.rawLosses = status.statistics.map(s => s.loss);
                    // #region agent log
                    fetch('http://127.0.0.1:7242/ingest/e751b283-9917-439e-b940-0a7eca19244e',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'index.html:558',message:'after overwriting raw data',data:{rawStepsLength:lossData.rawSteps.length,rawLossesLength:lossData.rawLosses.length,plotSettings:JSON.stringify(plotSettings)},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'B'})}).catch(()=>{});
                    // #endregion
                    applyPlotSettings();
                    updatePlot();
                } else {
                    // #region agent log
                    fetch('http://127.0.0.1:7242/ingest/e751b283-9917-439e-b940-0a7eca19244e',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'index.html:562',message:'no statistics in status',data:{hasStatistics:!!status.statistics,statisticsLength:status.statistics?.length||0,rawStepsLength:lossData.rawSteps.length},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'A'})}).catch(()=>{});
                    // #endregion
                }
            } catch (error) {
                // #region agent log
                fetch('http://127.0.0.1:7242/ingest/e751b283-9917-439e-b940-0a7eca19244e',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'index.html:565',message:'updateJobStatus error',data:{error:error.message},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'A'})}).catch(()=>{});
                // #endregion
                console.error('Error updating status:', error);
            }
        }

        function connectWebSocket(jobName) {
            if (socket) {
                socket.disconnect();
            }

            socket = io();
            
            socket.on('connect', () => {
                socket.emit('subscribe_logs', { job_name: jobName });
            });

            socket.on('log_line', (data) => {
                const logDisplay = document.getElementById('logDisplay');
                const line = document.createElement('div');
                line.className = 'log-line';
                line.textContent = data.line;
                logDisplay.appendChild(line);
                logDisplay.scrollTop = logDisplay.scrollHeight;
            });

            socket.on('statistics', (data) => {
                const stats = data.stats;
                // #region agent log
                fetch('http://127.0.0.1:7242/ingest/e751b283-9917-439e-b940-0a7eca19244e',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'index.html:517',message:'statistics received',data:{step:stats.step,loss:stats.loss,rawStepsLengthBefore:lossData.rawSteps.length},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'D'})}).catch(()=>{});
                // #endregion
                lossData.rawSteps.push(stats.step);
                lossData.rawLosses.push(stats.loss);
                // #region agent log
                fetch('http://127.0.0.1:7242/ingest/e751b283-9917-439e-b940-0a7eca19244e',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'index.html:520',message:'after adding statistics',data:{rawStepsLength:lossData.rawSteps.length,rawLossesLength:lossData.rawLosses.length},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'D'})}).catch(()=>{});
                // #endregion
                applyPlotSettings();
                updatePlot();
            });

            socket.on('job_finished', () => {
                document.getElementById('launchBtn').classList.remove('hidden');
                document.getElementById('stopBtn').classList.add('hidden');
                document.getElementById('jobStatus').textContent = 'Status: Finished';
                document.getElementById('jobStatus').className = 'status finished';
            });

            socket.on('job_stopped', () => {
                document.getElementById('launchBtn').classList.remove('hidden');
                document.getElementById('stopBtn').classList.add('hidden');
                document.getElementById('jobStatus').textContent = 'Status: Stopped';
                document.getElementById('jobStatus').className = 'status stopped';
            });
        }

        function calculateMovingAverage(values, windowSize) {
            if (values.length === 0) return [];
            if (windowSize <= 1) return values;
            
            const smoothed = [];
            const halfWindow = Math.floor(windowSize / 2);
            
            for (let i = 0; i < values.length; i++) {
                const start = Math.max(0, i - halfWindow);
                const end = Math.min(values.length, i + halfWindow + 1);
                const window = values.slice(start, end);
                const avg = window.reduce((a, b) => a + b, 0) / window.length;
                smoothed.push(avg);
            }
            
            return smoothed;
        }

        function applyStepRange(steps, losses, minStep, maxStep) {
            if (steps.length === 0) return { steps: [], losses: [] };
            
            let filteredSteps = steps;
            let filteredLosses = losses;
            
            if (minStep !== null && minStep !== '') {
                const minIdx = steps.findIndex(s => s >= minStep);
                if (minIdx >= 0) {
                    filteredSteps = filteredSteps.slice(minIdx);
                    filteredLosses = filteredLosses.slice(minIdx);
                } else {
                    // All steps are below minStep
                    return { steps: [], losses: [] };
                }
            }
            
            if (maxStep !== null && maxStep !== '') {
                const maxIdx = filteredSteps.findIndex(s => s > maxStep);
                if (maxIdx >= 0) {
                    filteredSteps = filteredSteps.slice(0, maxIdx);
                    filteredLosses = filteredLosses.slice(0, maxIdx);
                }
            }
            
            return { steps: filteredSteps, losses: filteredLosses };
        }

        function applyPlotSettings() {
            // #region agent log
            const stackTrace = new Error().stack;
            fetch('http://127.0.0.1:7242/ingest/e751b283-9917-439e-b940-0a7eca19244e',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'index.html:680',message:'applyPlotSettings entry',data:{rawStepsLength:lossData.rawSteps.length,rawLossesLength:lossData.rawLosses.length,minStep:plotSettings.minStep,maxStep:plotSettings.maxStep,movingAverage:plotSettings.movingAverage,windowSize:plotSettings.windowSize,stackTrace:stackTrace?.split('\n').slice(0,5).join(' | ')},timestamp:Date.now(),sessionId:'debug-session',runId:'run2',hypothesisId:'E'})}).catch(()=>{});
            // #endregion

            // Start with raw data
            let steps = [...lossData.rawSteps];
            let losses = [...lossData.rawLosses];
            
            // #region agent log
            fetch('http://127.0.0.1:7242/ingest/e751b283-9917-439e-b940-0a7eca19244e',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'index.html:658',message:'before step range filter',data:{stepsLength:steps.length,lossesLength:losses.length,firstStep:steps[0],lastStep:steps[steps.length-1]},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'B'})}).catch(()=>{});
            // #endregion

            // Apply step range filter
            if (plotSettings.minStep !== null || plotSettings.maxStep !== null) {
                const filtered = applyStepRange(steps, losses, plotSettings.minStep, plotSettings.maxStep);
                steps = filtered.steps;
                losses = filtered.losses;
                // #region agent log
                fetch('http://127.0.0.1:7242/ingest/e751b283-9917-439e-b940-0a7eca19244e',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'index.html:662',message:'after step range filter',data:{stepsLength:steps.length,lossesLength:losses.length,minStep:plotSettings.minStep,maxStep:plotSettings.maxStep},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'B'})}).catch(()=>{});
                // #endregion
            }
            
            // Apply moving average if enabled
            if (plotSettings.movingAverage && losses.length > 0) {
                losses = calculateMovingAverage(losses, plotSettings.windowSize);
                // #region agent log
                fetch('http://127.0.0.1:7242/ingest/e751b283-9917-439e-b940-0a7eca19244e',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'index.html:667',message:'after moving average',data:{lossesLength:losses.length,windowSize:plotSettings.windowSize},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'C'})}).catch(()=>{});
                // #endregion
            }
            
            // Update the display arrays
            lossData.steps = steps;
            lossData.losses = losses;
            // #region agent log
            fetch('http://127.0.0.1:7242/ingest/e751b283-9917-439e-b940-0a7eca19244e',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'index.html:673',message:'applyPlotSettings exit',data:{finalStepsLength:lossData.steps.length,finalLossesLength:lossData.losses.length},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'B'})}).catch(()=>{});
            // #endregion
        }

        function updatePlot() {
            // #region agent log
            const stackTrace = new Error().stack;
            fetch('http://127.0.0.1:7242/ingest/e751b283-9917-439e-b940-0a7eca19244e',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'index.html:719',message:'updatePlot entry',data:{stepsLength:lossData.steps.length,lossesLength:lossData.losses.length,rawStepsLength:lossData.rawSteps.length,rawLossesLength:lossData.rawLosses.length,showRaw:plotSettings.showRaw,movingAverage:plotSettings.movingAverage,stackTrace:stackTrace?.split('\n').slice(0,5).join(' | ')},timestamp:Date.now(),sessionId:'debug-session',runId:'run2',hypothesisId:'E'})}).catch(()=>{});
            // #endregion

            const traces = [];
            
            // Add smoothed/filtered trace
            if (lossData.steps.length > 0) {
                traces.push({
                    x: lossData.steps,
                    y: lossData.losses,
                    type: 'scatter',
                    mode: 'lines+markers',
                    name: plotSettings.movingAverage ? 'Smoothed Loss' : 'Loss',
                    line: { color: '#007bff', width: 2 },
                    marker: { size: 4 }
                });
            }
            
            // Add raw trace if enabled and moving average is on
            if (plotSettings.showRaw && plotSettings.movingAverage && lossData.rawSteps.length > 0) {
                let rawSteps = [...lossData.rawSteps];
                let rawLosses = [...lossData.rawLosses];
                
                // Apply step range to raw data too
                if (plotSettings.minStep !== null || plotSettings.maxStep !== null) {
                    const filtered = applyStepRange(rawSteps, rawLosses, plotSettings.minStep, plotSettings.maxStep);
                    rawSteps = filtered.steps;
                    rawLosses = filtered.losses;
                }
                
                traces.push({
                    x: rawSteps,
                    y: rawLosses,
                    type: 'scatter',
                    mode: 'lines+markers',
                    name: 'Raw Loss',
                    line: { color: '#cccccc', width: 1 },
                    marker: { size: 2, opacity: 0.5 }
                });
            }
            
            // #region agent log
            fetch('http://127.0.0.1:7242/ingest/e751b283-9917-439e-b940-0a7eca19244e',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'index.html:710',message:'before Plotly.react',data:{tracesLength:traces.length,hasMainTrace:lossData.steps.length>0,hasRawTrace:plotSettings.showRaw&&plotSettings.movingAverage&&lossData.rawSteps.length>0},timestamp:Date.now(),sessionId:'debug-session',runId:'post-fix',hypothesisId:'C'})}).catch(()=>{});
            // #endregion

            // Don't update plot if there are no traces - this prevents clearing an existing plot
            if (traces.length === 0) {
                // #region agent log
                fetch('http://127.0.0.1:7242/ingest/e751b283-9917-439e-b940-0a7eca19244e',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'index.html:714',message:'skipping Plotly.react - no traces',data:{tracesLength:traces.length,rawStepsLength:lossData.rawSteps.length},timestamp:Date.now(),sessionId:'debug-session',runId:'post-fix',hypothesisId:'C'})}).catch(()=>{});
                // #endregion
                return;
            }

            const layout = {
                title: 'Training Loss',
                xaxis: { title: 'Steps' },
                yaxis: { title: 'Loss' },
                margin: { l: 60, r: 20, t: 40, b: 60 },
                showlegend: traces.length > 1,
                hovermode: 'closest'
            };

            try {
                Plotly.react('lossPlot', traces, layout, { responsive: true });
                // #region agent log
                fetch('http://127.0.0.1:7242/ingest/e751b283-9917-439e-b940-0a7eca19244e',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'index.html:728',message:'Plotly.react success',data:{tracesLength:traces.length},timestamp:Date.now(),sessionId:'debug-session',runId:'post-fix',hypothesisId:'C'})}).catch(()=>{});
                // #endregion
            } catch (error) {
                // #region agent log
                fetch('http://127.0.0.1:7242/ingest/e751b283-9917-439e-b940-0a7eca19244e',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'index.html:731',message:'Plotly.react error',data:{error:error.message,tracesLength:traces.length},timestamp:Date.now(),sessionId:'debug-session',runId:'post-fix',hypothesisId:'C'})}).catch(()=>{});
                // #endregion
                console.error('Plotly.react error:', error);
            }
        }

        // Poll for status updates
        setInterval(() => {
            if (currentJob) {
                updateJobStatus();
            }
        }, 2000);
    </script>
</body>
</html>
